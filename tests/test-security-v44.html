<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliMaint Pro v44 å®‰å…¨æµ‹è¯•</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #1890ff; border-bottom: 2px solid #1890ff; padding-bottom: 10px; }
        h2 { color: #333; margin-top: 30px; }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #40a9ff; }
        button:disabled { background: #d9d9d9; cursor: not-allowed; }
        button.danger { background: #ff4d4f; }
        button.danger:hover { background: #ff7875; }
        button.success { background: #52c41a; }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { background: #f6ffed; border: 1px solid #b7eb8f; }
        .result.error { background: #fff2f0; border: 1px solid #ffccc7; }
        .result.info { background: #e6f7ff; border: 1px solid #91d5ff; }
        .pass { color: #52c41a; }
        .fail { color: #ff4d4f; }
        .info-text { color: #1890ff; }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .stat {
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat.pass { background: #f6ffed; border: 1px solid #b7eb8f; }
        .stat.fail { background: #fff2f0; border: 1px solid #ffccc7; }
        .stat-num { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 14px; color: #666; }
        input {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #52c41a);
            transition: width 0.3s;
        }
        #tokenDisplay {
            word-break: break-all;
            font-size: 11px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ğŸ”’ IntelliMaint Pro v44 å®‰å…¨æµ‹è¯•</h1>
    
    <div class="stats">
        <div class="stat pass">
            <div class="stat-num" id="passCount">0</div>
            <div class="stat-label">é€šè¿‡</div>
        </div>
        <div class="stat fail">
            <div class="stat-num" id="failCount">0</div>
            <div class="stat-label">å¤±è´¥</div>
        </div>
    </div>

    <!-- é…ç½® -->
    <div class="card">
        <h2>âš™ï¸ é…ç½®</h2>
        <div>
            <input type="text" id="baseUrl" value="http://localhost:5000" placeholder="API åœ°å€">
            <input type="text" id="username" value="admin" placeholder="ç”¨æˆ·å">
            <input type="password" id="password" value="admin123" placeholder="å¯†ç ">
        </div>
        <div style="margin-top: 10px;">
            <button onclick="runAllTests()">â–¶ï¸ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
            <button onclick="clearResults()" class="danger">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>
    </div>

    <!-- æµ‹è¯• 1: JWT è®¤è¯ -->
    <div class="card">
        <h2>ğŸ”‘ æµ‹è¯• 1: JWT è®¤è¯</h2>
        <button onclick="testLogin()">ç™»å½•æµ‹è¯•</button>
        <button onclick="testLoginFail()">ç™»å½•å¤±è´¥æµ‹è¯•</button>
        <button onclick="testTokenRefresh()">Token åˆ·æ–°</button>
        <button onclick="testNoAuth()">æ—  Token è®¿é—®</button>
        <div id="tokenDisplay"></div>
        <div id="result1" class="result info"></div>
    </div>

    <!-- æµ‹è¯• 2: SignalR æˆæƒ -->
    <div class="card">
        <h2>ğŸ“¡ æµ‹è¯• 2: SignalR æˆæƒ</h2>
        <button onclick="testSignalRNoAuth()">æ—  Token è¿æ¥</button>
        <button onclick="testSignalRWithAuth()">æœ‰ Token è¿æ¥</button>
        <button onclick="testSignalRQueryString()">Query String Token</button>
        <div id="result2" class="result info"></div>
    </div>

    <!-- æµ‹è¯• 3: è¯·æ±‚é™æµ -->
    <div class="card">
        <h2>ğŸš¦ æµ‹è¯• 3: è¯·æ±‚é™æµ</h2>
        <button onclick="testRateLimit()">å‘é€ 110 æ¬¡è¯·æ±‚</button>
        <div class="progress" style="display: none;" id="rateLimitProgress">
            <div class="progress-bar" id="rateLimitBar" style="width: 0%"></div>
        </div>
        <div id="result3" class="result info"></div>
    </div>

    <!-- æµ‹è¯• 4: å®¡è®¡æ—¥å¿— -->
    <div class="card">
        <h2>ğŸ“‹ æµ‹è¯• 4: å®¡è®¡æ—¥å¿—</h2>
        <button onclick="testAuditLog()">æŸ¥è¯¢å®¡è®¡æ—¥å¿—</button>
        <div id="result4" class="result info"></div>
    </div>

    <!-- æµ‹è¯• 5: RBAC æƒé™ -->
    <div class="card">
        <h2>ğŸ‘¥ æµ‹è¯• 5: RBAC æƒé™</h2>
        <button onclick="testRbacAdmin()">Admin æƒé™æµ‹è¯•</button>
        <div id="result5" class="result info"></div>
    </div>

    <script>
        let token = null;
        let refreshToken = null;
        let passCount = 0;
        let failCount = 0;

        function getConfig() {
            return {
                baseUrl: document.getElementById('baseUrl').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
        }

        function updateStats() {
            document.getElementById('passCount').textContent = passCount;
            document.getElementById('failCount').textContent = failCount;
        }

        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const icon = type === 'pass' ? 'âœ…' : type === 'fail' ? 'âŒ' : 'â„¹ï¸';
            const className = type === 'pass' ? 'pass' : type === 'fail' ? 'fail' : 'info-text';
            el.innerHTML += `<span class="${className}">${icon} ${message}</span>\n`;
            el.scrollTop = el.scrollHeight;
            
            if (type === 'pass') passCount++;
            if (type === 'fail') failCount++;
            updateStats();
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function clearResults() {
            for (let i = 1; i <= 5; i++) {
                clearLog(`result${i}`);
            }
            document.getElementById('tokenDisplay').textContent = '';
            passCount = 0;
            failCount = 0;
            updateStats();
        }

        // æµ‹è¯• 1: ç™»å½•
        async function testLogin() {
            clearLog('result1');
            const config = getConfig();
            
            try {
                log('result1', 'æ­£åœ¨ç™»å½•...');
                const response = await fetch(`${config.baseUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: config.username, password: config.password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    token = data.data.token;
                    refreshToken = data.data.refreshToken;
                    log('result1', `ç™»å½•æˆåŠŸï¼Œè§’è‰²: ${data.data.role}`, 'pass');
                    log('result1', `è·å– Token`, 'pass');
                    log('result1', `è·å– Refresh Token`, 'pass');
                    document.getElementById('tokenDisplay').textContent = `Token: ${token.substring(0, 50)}...`;
                } else {
                    log('result1', `ç™»å½•å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'fail');
                }
            } catch (e) {
                log('result1', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // æµ‹è¯•ç™»å½•å¤±è´¥
        async function testLoginFail() {
            const config = getConfig();
            
            try {
                log('result1', 'æµ‹è¯•é”™è¯¯å¯†ç ç™»å½•...');
                const response = await fetch(`${config.baseUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: config.username, password: 'wrongpassword' })
                });
                
                if (response.status === 401) {
                    log('result1', 'é”™è¯¯å¯†ç è¿”å› 401', 'pass');
                } else {
                    log('result1', `é¢„æœŸ 401ï¼Œå®é™… ${response.status}`, 'fail');
                }
            } catch (e) {
                log('result1', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // Token åˆ·æ–°
        async function testTokenRefresh() {
            if (!refreshToken) {
                log('result1', 'è¯·å…ˆç™»å½•è·å– Refresh Token', 'fail');
                return;
            }
            
            const config = getConfig();
            
            try {
                log('result1', 'æ­£åœ¨åˆ·æ–° Token...');
                const response = await fetch(`${config.baseUrl}/api/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const oldToken = token;
                    token = data.data.token;
                    refreshToken = data.data.refreshToken;
                    
                    if (token !== oldToken) {
                        log('result1', 'Token åˆ·æ–°æˆåŠŸ (æ–° Token ä¸åŒ)', 'pass');
                        document.getElementById('tokenDisplay').textContent = `Token: ${token.substring(0, 50)}...`;
                    } else {
                        log('result1', 'Token æœªå˜åŒ–', 'fail');
                    }
                } else {
                    log('result1', `Token åˆ·æ–°å¤±è´¥: ${data.error}`, 'fail');
                }
            } catch (e) {
                log('result1', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // æ—  Token è®¿é—®
        async function testNoAuth() {
            const config = getConfig();
            
            try {
                log('result1', 'æµ‹è¯•æ—  Token è®¿é—®å—ä¿æŠ¤èµ„æº...');
                const response = await fetch(`${config.baseUrl}/api/devices`);
                
                if (response.status === 401) {
                    log('result1', 'æ—  Token è¿”å› 401', 'pass');
                } else {
                    log('result1', `é¢„æœŸ 401ï¼Œå®é™… ${response.status}`, 'fail');
                }
            } catch (e) {
                log('result1', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // SignalR æ—  Token
        async function testSignalRNoAuth() {
            clearLog('result2');
            const config = getConfig();
            
            try {
                log('result2', 'æµ‹è¯• SignalR æ—  Token è¿æ¥...');
                const response = await fetch(`${config.baseUrl}/hubs/telemetry/negotiate?negotiateVersion=1`, {
                    method: 'POST'
                });
                
                if (response.status === 401) {
                    log('result2', 'SignalR æ—  Token è¿”å› 401', 'pass');
                } else {
                    log('result2', `é¢„æœŸ 401ï¼Œå®é™… ${response.status}`, 'fail');
                }
            } catch (e) {
                log('result2', `è¿æ¥è¢«æ‹’ç» (é¢„æœŸè¡Œä¸º)`, 'pass');
            }
        }

        // SignalR æœ‰ Token
        async function testSignalRWithAuth() {
            if (!token) {
                log('result2', 'è¯·å…ˆç™»å½•è·å– Token', 'fail');
                return;
            }
            
            const config = getConfig();
            
            try {
                log('result2', 'æµ‹è¯• SignalR æœ‰ Token è¿æ¥...');
                const response = await fetch(`${config.baseUrl}/hubs/telemetry/negotiate?negotiateVersion=1`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 200) {
                    log('result2', 'SignalR æœ‰ Token è¿”å› 200', 'pass');
                } else {
                    log('result2', `é¢„æœŸ 200ï¼Œå®é™… ${response.status}`, 'fail');
                }
            } catch (e) {
                log('result2', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // SignalR Query String
        async function testSignalRQueryString() {
            if (!token) {
                log('result2', 'è¯·å…ˆç™»å½•è·å– Token', 'fail');
                return;
            }
            
            const config = getConfig();
            
            try {
                log('result2', 'æµ‹è¯• SignalR Query String Token...');
                const response = await fetch(`${config.baseUrl}/hubs/telemetry/negotiate?negotiateVersion=1&access_token=${token}`, {
                    method: 'POST'
                });
                
                if (response.status === 200) {
                    log('result2', 'SignalR Query String Token æœ‰æ•ˆ', 'pass');
                } else {
                    log('result2', `é¢„æœŸ 200ï¼Œå®é™… ${response.status}`, 'fail');
                }
            } catch (e) {
                log('result2', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // é™æµæµ‹è¯•
        async function testRateLimit() {
            if (!token) {
                log('result3', 'è¯·å…ˆç™»å½•è·å– Token', 'fail');
                return;
            }
            
            clearLog('result3');
            const config = getConfig();
            
            const progressContainer = document.getElementById('rateLimitProgress');
            const progressBar = document.getElementById('rateLimitBar');
            progressContainer.style.display = 'block';
            
            log('result3', 'å¼€å§‹å‘é€ 110 æ¬¡è¯·æ±‚...');
            
            let successCount = 0;
            let limitedCount = 0;
            const total = 110;
            
            for (let i = 1; i <= total; i++) {
                try {
                    const response = await fetch(`${config.baseUrl}/api/devices`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.status === 200) {
                        successCount++;
                    } else if (response.status === 429) {
                        limitedCount++;
                    }
                    
                    progressBar.style.width = `${(i / total) * 100}%`;
                    
                    if (i % 20 === 0) {
                        log('result3', `è¿›åº¦: ${i}/${total} (æˆåŠŸ: ${successCount}, é™æµ: ${limitedCount})`);
                    }
                } catch (e) {
                    // å¿½ç•¥å•ä¸ªè¯·æ±‚é”™è¯¯
                }
            }
            
            log('result3', `\næœ€ç»ˆç»“æœ: æˆåŠŸ=${successCount}, è¢«é™æµ=${limitedCount}`);
            
            if (successCount >= 95 && successCount <= 105) {
                log('result3', `æˆåŠŸè¯·æ±‚æ•°çº¦ 100 (å®é™…: ${successCount})`, 'pass');
            } else {
                log('result3', `æˆåŠŸè¯·æ±‚æ•°å¼‚å¸¸ (å®é™…: ${successCount})`, 'fail');
            }
            
            if (limitedCount >= 5) {
                log('result3', `è¢«é™æµè¯·æ±‚æ•° >= 5 (å®é™…: ${limitedCount})`, 'pass');
            } else {
                log('result3', `é™æµæœªç”Ÿæ•ˆ (è¢«é™æµ: ${limitedCount})`, 'fail');
            }
        }

        // å®¡è®¡æ—¥å¿—
        async function testAuditLog() {
            if (!token) {
                log('result4', 'è¯·å…ˆç™»å½•è·å– Token', 'fail');
                return;
            }
            
            clearLog('result4');
            const config = getConfig();
            
            try {
                log('result4', 'æŸ¥è¯¢å®¡è®¡æ—¥å¿—...');
                const response = await fetch(`${config.baseUrl}/api/audit?pageSize=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('result4', 'å®¡è®¡æ—¥å¿—æŸ¥è¯¢æˆåŠŸ', 'pass');
                    
                    const items = data.data.items || [];
                    log('result4', `å…± ${items.length} æ¡è®°å½•`, 'pass');
                    
                    // æ£€æŸ¥ç™»å½•è®°å½•
                    const loginLogs = items.filter(x => x.action === 'Login');
                    if (loginLogs.length > 0) {
                        log('result4', 'åŒ…å«ç™»å½•å®¡è®¡è®°å½•', 'pass');
                    } else {
                        log('result4', 'æœªæ‰¾åˆ°ç™»å½•å®¡è®¡è®°å½•', 'fail');
                    }
                    
                    // æ£€æŸ¥ IP åœ°å€
                    const hasIp = items.some(x => x.ipAddress);
                    if (hasIp) {
                        log('result4', 'å®¡è®¡è®°å½•åŒ…å« IP åœ°å€', 'pass');
                    } else {
                        log('result4', 'å®¡è®¡è®°å½•æ—  IP åœ°å€', 'fail');
                    }
                    
                    // æ˜¾ç¤ºæœ€è¿‘è®°å½•
                    log('result4', '\næœ€è¿‘å®¡è®¡è®°å½•:');
                    items.slice(0, 5).forEach(item => {
                        const time = new Date(item.ts).toLocaleTimeString();
                        log('result4', `  [${time}] ${item.userName} - ${item.action} - IP: ${item.ipAddress || 'N/A'}`);
                    });
                } else {
                    log('result4', `æŸ¥è¯¢å¤±è´¥: ${data.error}`, 'fail');
                }
            } catch (e) {
                log('result4', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // RBAC æµ‹è¯•
        async function testRbacAdmin() {
            if (!token) {
                log('result5', 'è¯·å…ˆç™»å½•è·å– Token', 'fail');
                return;
            }
            
            clearLog('result5');
            const config = getConfig();
            
            try {
                log('result5', 'æµ‹è¯• Admin è®¿é—®ç”¨æˆ·ç®¡ç†...');
                const usersResponse = await fetch(`${config.baseUrl}/api/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (usersResponse.status === 200) {
                    log('result5', 'Admin å¯è®¿é—®ç”¨æˆ·ç®¡ç†', 'pass');
                } else {
                    log('result5', `ç”¨æˆ·ç®¡ç†è®¿é—®å¤±è´¥: ${usersResponse.status}`, 'fail');
                }
                
                log('result5', 'æµ‹è¯• Admin è®¿é—®ç³»ç»Ÿè®¾ç½®...');
                const settingsResponse = await fetch(`${config.baseUrl}/api/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (settingsResponse.status === 200) {
                    log('result5', 'Admin å¯è®¿é—®ç³»ç»Ÿè®¾ç½®', 'pass');
                } else {
                    log('result5', `ç³»ç»Ÿè®¾ç½®è®¿é—®å¤±è´¥: ${settingsResponse.status}`, 'fail');
                }
            } catch (e) {
                log('result5', `è¯·æ±‚å¼‚å¸¸: ${e.message}`, 'fail');
            }
        }

        // è¿è¡Œå…¨éƒ¨æµ‹è¯•
        async function runAllTests() {
            clearResults();
            
            await testLogin();
            await new Promise(r => setTimeout(r, 500));
            
            await testLoginFail();
            await new Promise(r => setTimeout(r, 500));
            
            await testTokenRefresh();
            await new Promise(r => setTimeout(r, 500));
            
            await testNoAuth();
            await new Promise(r => setTimeout(r, 500));
            
            await testSignalRNoAuth();
            await new Promise(r => setTimeout(r, 500));
            
            await testSignalRWithAuth();
            await new Promise(r => setTimeout(r, 500));
            
            await testSignalRQueryString();
            await new Promise(r => setTimeout(r, 500));
            
            // é™æµæµ‹è¯•æ¯”è¾ƒæ…¢ï¼Œå•ç‹¬æç¤º
            log('result3', 'â³ é™æµæµ‹è¯•éœ€è¦çº¦ 30 ç§’ï¼Œè¯·ç­‰å¾…...');
            await testRateLimit();
            
            // ç­‰å¾…é™æµçª—å£éƒ¨åˆ†æ¢å¤
            await new Promise(r => setTimeout(r, 3000));
            
            await testAuditLog();
            await new Promise(r => setTimeout(r, 500));
            
            await testRbacAdmin();
            
            // æ€»ç»“
            const total = passCount + failCount;
            const rate = total > 0 ? Math.round((passCount / total) * 100) : 0;
            
            alert(`æµ‹è¯•å®Œæˆï¼\n\né€šè¿‡: ${passCount}\nå¤±è´¥: ${failCount}\né€šè¿‡ç‡: ${rate}%`);
        }
    </script>
</body>
</html>
