---
name: analyze
description: 分析项目代码质量、架构健康度、技术债务
---

# 项目分析任务

请执行全面的项目分析：

## 1. 代码统计

分析项目代码量：

```bash
# 统计代码行数
find src -name "*.cs" | xargs wc -l
find intellimaint-ui/src -name "*.tsx" -o -name "*.ts" | xargs wc -l
```

生成统计报告：
- 后端代码行数
- 前端代码行数
- 测试代码行数
- 文件数量

## 2. 架构分析

使用 `architect` 视角分析：

### 模块依赖
- 核心层依赖是否正确？
- 是否有循环依赖？
- 层次边界是否清晰？

### 架构一致性
- 是否符合分层架构？
- 接口抽象是否合理？
- 是否有架构违规？

## 3. 代码质量分析

使用 `code-reviewer` 视角分析：

### 代码坏味道
- 过长的方法
- 过大的类
- 重复代码
- 复杂的条件
- 魔法数字

### 命名质量
- 是否遵循命名规范？
- 命名是否有意义？

## 4. 安全分析

使用 `security-expert` 视角分析：

### 安全检查
- SQL 注入风险
- XSS 风险
- 硬编码敏感信息
- 认证授权漏洞

## 5. 性能分析

使用 `performance-expert` 视角分析：

### 潜在性能问题
- 同步阻塞调用
- N+1 查询
- 缺少索引
- 内存泄漏风险

## 6. 技术债务识别

### 债务分类
- **架构债务**: 需要重构的架构问题
- **代码债务**: 需要清理的代码问题
- **测试债务**: 缺失的测试覆盖
- **文档债务**: 缺失的文档

### 债务评估
| 债务项 | 严重程度 | 修复成本 | 优先级 |
|--------|----------|----------|--------|
| xxx | 高/中/低 | 大/中/小 | P0-P3 |

## 7. 生成分析报告

```markdown
# 项目分析报告

## 概要
- **分析日期**: xxx
- **项目版本**: vXX
- **整体健康度**: ⭐⭐⭐⭐ (4/5)

## 代码统计
| 模块 | 文件数 | 代码行数 |
|------|--------|----------|
| Core | xx | xxxx |
| Infrastructure | xx | xxxx |
| Host.Api | xx | xxxx |
| UI | xx | xxxx |
| Tests | xx | xxxx |
| **总计** | xx | xxxx |

## 架构健康度

### 优点
- ✅ xxx
- ✅ xxx

### 问题
- ⚠️ xxx
- ⚠️ xxx

## 代码质量

### 优点
- ✅ xxx

### 需改进
- ⚠️ xxx

## 安全状态
- [x] SQL 注入防护
- [x] 认证机制
- [ ] xxx 需要改进

## 性能状态
- [x] 异步编程
- [ ] xxx 需要优化

## 技术债务清单

### 高优先级
1. xxx

### 中优先级
1. xxx

### 低优先级
1. xxx

## 建议行动

### 短期（1-2周）
1. xxx

### 中期（1个月）
1. xxx

### 长期（3个月）
1. xxx
```

---

**分析原则**：
1. 客观公正，基于事实
2. 量化指标优先
3. 提供可行建议
4. 关注投入产出比

## ⚠️ 质量门禁 (必须满足)

项目分析必须基于实际代码证据，所有发现需可追溯：

### 阶段 1: 数据收集
- [ ] **代码统计** - 实际运行统计命令
- [ ] **文件遍历** - 读取关键文件
- [ ] **依赖分析** - 分析项目引用

### 阶段 2: 问题识别
- [ ] **代码定位** - 问题精确到 `文件:行号`
- [ ] **代码证据** - 提供实际代码片段
- [ ] **严重等级** - 问题分级 (Critical/Warning/Info)

### 阶段 3: 报告生成
- [ ] **数据支撑** - 所有结论有数据证明
- [ ] **引用来源** - 标注文件和行号
- [ ] **分类清晰** - 已确认 vs 潜在风险

### 证据要求（必须满足）

| 分析类型 | 证据要求 |
|----------|----------|
| **代码坏味道** | 代码片段 + 文件:行号 |
| **安全问题** | 具体漏洞代码 + 利用方式 |
| **性能问题** | 问题代码 + 预期影响 |
| **架构问题** | 依赖图 + 违规点 |

### ❌ 不合格示例
```markdown
分析完成:
- 代码质量一般        ← 没有具体问题
- 可能有安全问题      ← 没有代码证据
- 建议重构           ← 没有具体位置
```

### ✅ 合格示例
```markdown
# 项目分析报告

## 代码统计
```bash
$ find src -name "*.cs" | xargs wc -l
   1234 src/Host.Api/Program.cs
   567 src/Infrastructure/Sqlite/DeviceRepository.cs
   ...
   总计: 15,678 行
```

## 已确认问题

### 🔴 Critical

#### 1. SQL 拼接风险
- **位置**: `src/Infrastructure/Sqlite/UserRepository.cs:45`
- **代码**:
```csharp
var sql = $"SELECT * FROM Users WHERE Username = '{username}'";
```
- **风险**: SQL 注入
- **建议**: 使用参数化查询

### 🟡 Warning

#### 1. 过长方法
- **位置**: `src/Host.Api/Endpoints/TelemetryEndpoints.cs:78-180`
- **问题**: 方法 102 行，超过 30 行建议值
- **建议**: 拆分为多个职责单一的方法

## 验证记录
| 检查项 | 文件 | 结果 |
|--------|------|------|
| SQL 注入 | DeviceRepository.cs | ✅ 参数化 |
| SQL 注入 | UserRepository.cs | ❌ 需修复 |
| 异步阻塞 | TelemetryEndpoints.cs | ✅ 无阻塞 |

## 技术债务汇总
| 类型 | 数量 | 示例 |
|------|------|------|
| 代码坏味道 | 5 | 过长方法 3 个 |
| 安全风险 | 1 | SQL 拼接 |
| 测试缺失 | 2 | Repository 无测试 |
```
